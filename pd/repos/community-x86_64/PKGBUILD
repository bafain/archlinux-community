# $Id$
# Maintainer: David Runge <dave@sleepmap.de>
# Contributor: speps <speps at aur dot archlinux dot org>
# Contributor: TDY <tdy@gmx.com>
# Contributor: Shinlun Hsieh <yngwiexx@yahoo.com.tw>

pkgname=pd
pkgver=0.48.2
_ver=${pkgver%.*}-${pkgver##*.}
pkgrel=5
pkgdesc="The Pure Data real-time music and multimedia environment"
arch=('x86_64')
url="http://msp.ucsd.edu/software.html"
license=('custom:BSD')
groups=('pro-audio')
depends=('fftw' 'portaudio' 'tk')
makedepends=('portmidi')
optdepends=('portmidi: for alternative portmidi support')
provides=('puredata')
source=("http://msp.ucsd.edu/Software/${pkgname}-${_ver}.src.tar.gz"
        "${pkgname}.desktop"
        "${pkgname}.png")
sha512sums=('cc626edb35631fe05b3cc4380b53724f87be94c65eecb2c03bff0906ff2da95f306011d4f5f27ca3da524ddc1bd0af5923d660f6c073d3ffd80bcbbc72f239c8'
            '4d3596b337456117ecdf0f1709358b4298198e0b347cb13b884e35ad2f2f667561a10b44683cf916c1da123daebee7141e9ab8bd89405a579b69d30b0e718f37'
            '61300b58f10018b0bd28424ac00d1b8158f8ace9855742e19e48c98f915cabcade6c6041460aa795005c0fb6abc93e7116f9999c6d001999916c9fe6c85c162d')

prepare() {
  mv -v "${pkgname}-${_ver}" "${pkgname}-${pkgver}"
  cd "${pkgname}-${pkgver}"
  autoreconf -vfi
}

build() {
  cd "${pkgname}-${pkgver}"
  ./configure --prefix=/usr \
              --enable-alsa \
              --enable-fftw \
              --enable-jack \
              --enable-portaudio \
              --enable-portmidi \
              --without-local-portaudio \
              --without-local-portmidi
  make
}

package() {
  cd "${pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}" install

  # license
  install -vDm 644 LICENSE.txt \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  # desktop file
  install -vDm 644 "${srcdir}/${pkgname}.desktop" \
    -t "${pkgdir}/usr/share/applications/"
  # icon from puredata.info
  # https://puredata.info/Members/claudiusmaximus/icons/index_html/
  install -vDm 644 "${srcdir}/${pkgname}.png" \
    -t "${pkgdir}/usr/share/pixmaps/"
  # readme
  install -vDm 644 README.txt -t "${pkgdir}/usr/share/doc/${pkgname}/"
  # fix broken symlink
  ls -lah "${pkgdir}/usr/lib/${pkgname}/bin/${pkgname}"
  rm -v "${pkgdir}/usr/lib/${pkgname}/bin/${pkgname}"
  ln -sv "/usr/bin/${pkgname}" "${pkgdir}/usr/lib/${pkgname}/bin/${pkgname}"
  ls -lah "${pkgdir}/usr/lib/${pkgname}/bin/${pkgname}"
}
