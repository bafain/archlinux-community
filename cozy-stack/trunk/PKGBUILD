# Maintainer: Bruno Pagani <archange@archlinux.org>

pkgname=cozy-stack
pkgver=2018M3S5
pkgrel=1
pkgdesc="Digital home: brings all your web services in the same private space â€“ Stack component"
arch=('x86_64')
url="https://cozy.io"
license=('AGPL3')
backup=('etc/cozy/cozy.yml')
depends=('couchdb' 'imagemagick' 'git')
makedepends=('go-pie')
#optdepends=('cozy-coclyco: X.509 certificates management for instances'
optdepends=('nodejs: konnectors without isolation'
            'nsjail: isolated konnectors'
            'smtp-forwarder: to allow sending mail to users')
source=("https://apt.cozy.io/debian/pool/testing/c/${pkgname}/${pkgname}_${pkgver}.orig.tar.xz"
        "cozy.yml"
        "${pkgname}.service"
        "${pkgname}.sysusers"
        "${pkgname}.tmpfiles")
sha256sums=('7ba285f1d1c73b8b8edebe984795bb1ef49b09795ca30437a5c0b568073e22a6'
            '450a41a054871b63ee0d968397d623faa50532269d875c0174633ea543701431'
            'f0a8cc43c51daeba92b36b449537eb6fa5d3fb84ef1428dc586266749ed742e0'
            'a6bea52350e85163c3141509a52903223fa0f6e7390b1b1f9336c326a8fff984'
            'fd333c2fd0de859890204554f52a5c64b953664f6cb262b20bb839aa70ed9ecb')

build() {
    cd cozy-stack/src/github.com/cozy/cozy-stack
    GOPATH="${srcdir}"/cozy-stack go build -o "${srcdir}"/bin/cozy-stack -ldflags "\
		-X github.com/cozy/cozy-stack/pkg/config.Version=${pkgver} \
		-X github.com/cozy/cozy-stack/pkg/config.BuildTime=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
        -X github.com/cozy/cozy-stack/pkg/config.BuildMode=production"
}

package() {
    install -Dm755 bin/cozy-stack -t "${pkgdir}"/usr/bin/
    install -Dm644 cozy.yml -t "${pkgdir}"/etc/cozy/
    install -Dm644 cozy-stack/src/github.com/cozy/cozy-stack/cozy.example.yaml -t "${pkgdir}"/usr/share/cozy/
    install -Dm755 cozy-stack/src/github.com/cozy/cozy-stack/scripts/konnector-node-run.sh -t "${pkgdir}"/usr/share/cozy/
    install -Dm755 cozy-stack/src/github.com/cozy/cozy-stack/scripts/konnector-nsjail-run.sh -t "${pkgdir}"/usr/share/cozy/
    install -Dm644 ${pkgname}.service -t "${pkgdir}"/usr/lib/systemd/system/
    install -Dm644 ${pkgname}.sysusers "${pkgdir}"/usr/lib/sysusers.d/${pkgname}.conf
    install -Dm644 ${pkgname}.tmpfiles "${pkgdir}"/usr/lib/tmpfiles.d/${pkgname}.conf
}
