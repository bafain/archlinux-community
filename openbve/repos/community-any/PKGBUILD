# Maintainer: Balló György <ballogyor+arch at gmail dot com>

pkgname=openbve
_pkgname=OpenBVE
pkgver=1.5.3.8
pkgrel=1
pkgdesc="Free-as-in-freedom train simulator placed in the public domain"
arch=('any')
url="http://openbve-project.net/"
license=('MIT' 'custom:public domain')
depends=('libxi' 'mono' 'openal')
source=($_pkgname-$pkgver.tar.gz::https://github.com/leezer3/$_pkgname/archive/$pkgver.tar.gz
        $pkgname.sh
        $pkgname.desktop
        force-close.patch)
sha256sums=('b7eaf59d26c2400c81fd9568fab141a23a0d536844164c9aa42d52ffd7a03338'
            'cf0f2a28e65248f742d6bb80f3101e36f24097e699c4e5acdf3fd4dbb965d3c3'
            '8190945fa834ecdcf8a3f271264e5be2e288933ecde943060346e16537611c0f'
            'b24f828f63fd0017afc49b266ea198725fd6fe3e68d1c86d40257047b6f7edfa')

prepare() {
  cd $_pkgname-$pkgver
  # Attempt to force close the window
  # https://github.com/leezer3/OpenBVE/pull/214
  patch -Np1 -i ../force-close.patch
}

build() {
  cd $_pkgname-$pkgver
  xbuild /p:Configuration=Release OpenBVE.sln
}

package() {
  cd $_pkgname-$pkgver

  # Binaries
  install -dm755 "$pkgdir/usr/lib/$pkgname/"
  cp -r bin_release/* "$pkgdir/usr/lib/$pkgname/"

  # Data
  install -dm755 "$pkgdir/usr/share/games/$pkgname/"
  mv "$pkgdir/usr/lib/$pkgname/Data" "$pkgdir/usr/share/games/$pkgname/"
  ln -s ../../share/games/$pkgname/Data "$pkgdir/usr/lib/$pkgname/Data"

  # Executable
  install -Dm755 ../$pkgname.sh "$pkgdir/usr/bin/$pkgname"

  # Desktop file and icon
  install -Dm644 ../$pkgname.desktop $pkgdir/usr/share/applications/$pkgname.desktop
  mkdir -p "$pkgdir/usr/share/pixmaps"
  ln -s ../games/$pkgname/Data/Menu/logo.png "$pkgdir/usr/share/pixmaps/$pkgname.png"

  # License
  install -dm755 "$pkgdir/usr/share/licenses/$pkgname/"
  install -m644 licenses/* Readme.md \
    "$pkgdir/usr/share/licenses/$pkgname/"
}
